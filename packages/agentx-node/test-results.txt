
> @deepractice-ai/agentx-node@0.1.0 test /Users/sean/Deepractice/projects/Agent/packages/agentx-node
> pnpm run copy:features && vitest run


> @deepractice-ai/agentx-node@0.1.0 copy:features /Users/sean/Deepractice/projects/Agent/packages/agentx-node
> mkdir -p dist/features && cp -r node_modules/@deepractice-ai/agentx-api/features/* dist/features/


 RUN  v3.2.4 /Users/sean/Deepractice/projects/Agent/packages/agentx-node

stdout | dist/features/error-handling.feature

============================================================
ğŸŒ Test Mode: Real Claude API
   Base URL: http://118.178.86.178/api
   Auth Token: cr_9e35c66a9ceb9d89c...
============================================================


stdout | dist/features/agent-lifecycle.feature

============================================================
ğŸŒ Test Mode: Real Claude API
   Base URL: http://118.178.86.178/api
   Auth Token: cr_9e35c66a9ceb9d89c...
============================================================


stdout | dist/features/agent-messaging.feature

============================================================
ğŸŒ Test Mode: Real Claude API
   Base URL: http://118.178.86.178/api
   Auth Token: cr_9e35c66a9ceb9d89c...
============================================================


stdout | dist/features/agent-events.feature

============================================================
ğŸŒ Test Mode: Real Claude API
   Base URL: http://118.178.86.178/api
   Auth Token: cr_9e35c66a9ceb9d89c...
============================================================


stdout | dist/features/agent-configuration.feature

============================================================
ğŸŒ Test Mode: Real Claude API
   Base URL: http://118.178.86.178/api
   Auth Token: cr_9e35c66a9ceb9d89c...
============================================================


 âœ“ dist/features/agent-configuration.feature (9 tests) 24829ms
   âœ“ Agent Configuration > Configure system prompt  9014ms
   âœ“ Agent Configuration > Configure MCP servers with stdio transport  15694ms
 â¯ dist/features/error-handling.feature (10 tests | 6 failed) 42888ms
   âœ“ Error Handling > Handle configuration errors 2ms
   Ã— Error Handling > Catch abort errors 9480ms
     â†’ expected Error: Claude Code process exited with coâ€¦ to be undefined
   Ã— Error Handling > Handle network failures 9683ms
     â†’ expected 'Claude Code process exited with code 1' to match /network|simulated/i
   Ã— Error Handling > Handle API errors 5099ms
     â†’ expected 'success' to match /^error/
   Ã— Error Handling > Handle max turns error 5362ms
     â†’ expected 'success' to be 'error_max_turns' // Object.is equality
   Ã— Error Handling > Handle execution errors 7902ms
     â†’ expected 'success' to be 'error_during_execution' // Object.is equality
   âœ“ Error Handling > Distinguish error types 1ms
   âœ“ Error Handling > Error includes stack trace 1ms
   âœ“ Error Handling > Errors don't leak sensitive information 1ms
   Ã— Error Handling > Graceful degradation on partial failures 5238ms
     â†’ Claude Code process exited with code 1
 â¯ dist/features/agent-lifecycle.feature (8 tests | 2 failed) 62956ms
   âœ“ Agent Lifecycle Management > Agent has unique ID 3ms
   Ã— Agent Lifecycle Management > Agent tracks session ID 8958ms
     â†’ Claude Code process exited with code 1
   âœ“ Agent Lifecycle Management > Clear conversation history  40741ms
   âœ“ Agent Lifecycle Management > Abort ongoing operation 13ms
   âœ“ Agent Lifecycle Management > Destroy agent and cleanup resources 1ms
   Ã— Agent Lifecycle Management > Multiple agents in same application 5955ms
     â†’ Claude Code process exited with code 1
   âœ“ Agent Lifecycle Management > Session persistence across restarts  7152ms
   âœ“ Agent Lifecycle Management > Graceful error handling during destroy 15ms
 â¯ dist/features/agent-events.feature (8 tests | 1 failed) 67223ms
   âœ“ Agent Event Handling > Listen for assistant messages  9048ms
   âœ“ Agent Event Handling > Listen for result events  10295ms
   âœ“ Agent Event Handling > Unregister event handlers  6992ms
   âœ“ Agent Event Handling > Multiple handlers for same event  7795ms
   âœ“ Agent Event Handling > Event handlers receive typed data  6996ms
   âœ“ Agent Event Handling > Listen for system initialization  8326ms
   âœ“ Agent Event Handling > Stream events during response  14034ms
   Ã— Agent Event Handling > Error result events 3616ms
     â†’ expected 'success' to match /^error/
 â¯ dist/features/agent-messaging.feature (7 tests | 1 failed) 87179ms
   âœ“ Agent Messaging > Send a simple text message  6309ms
   Ã— Agent Messaging > Receive streaming responses 22314ms
     â†’ expected undefined to be defined
   âœ“ Agent Messaging > Access conversation history  24159ms
   âœ“ Agent Messaging > Send message with context  10885ms
   âœ“ Agent Messaging > Track token usage  6718ms
   âœ“ Agent Messaging > Track conversation cost  5199ms
   âœ“ Agent Messaging > Multiple messages in sequence  11477ms

â¯â¯â¯â¯â¯â¯ Failed Tests 10 â¯â¯â¯â¯â¯â¯â¯

 FAIL  dist/features/agent-events.feature > Agent Event Handling > Error result events
AssertionError: expected 'success' to match /^error/

[32m- Expected:[39m 
/^error/

[31m+ Received:[39m 
"success"

 â¯ Object.<anonymous> tests/steps/events.steps.ts:335:32
    333|   expect(resultEvent).toBeDefined();
    334|   // Error subtypes include error_during_execution, error_max_turns, eâ€¦
    335|   expect(resultEvent!.subtype).toMatch(/^error/);
       |                                ^
    336| });
    337| 
 â¯ StepExecutor.execute ../../node_modules/.pnpm/@deepracticex+vitest-cucumber@1.4.0_vitest@3.2.4/node_modules/@deepracticex/vitest-cucumber/src/core/runtime/StepExecutor.ts:31:25
 â¯ dist/features/agent-events.feature:298:20

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/10]â¯

 FAIL  dist/features/agent-lifecycle.feature > Agent Lifecycle Management > Agent tracks session ID
 FAIL  dist/features/agent-lifecycle.feature > Agent Lifecycle Management > Multiple agents in same application
 FAIL  dist/features/error-handling.feature > Error Handling > Graceful degradation on partial failures
Error: Claude Code process exited with code 1
 â¯ ProcessTransport.getProcessExitError ../../node_modules/.pnpm/@anthropic-ai+claude-agent-sdk@0.1.30_zod@4.1.12/node_modules/@anthropic-ai/claude-agent-sdk/sdk.mjs:6564:14
 â¯ ChildProcess.exitHandler ../../node_modules/.pnpm/@anthropic-ai+claude-agent-sdk@0.1.30_zod@4.1.12/node_modules/@anthropic-ai/claude-agent-sdk/sdk.mjs:6701:28

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/10]â¯

 FAIL  dist/features/agent-messaging.feature > Agent Messaging > Receive streaming responses
AssertionError: expected undefined to be defined
 â¯ tests/steps/messaging.steps.ts:99:25
     97|   context.streamEvents.forEach((event) => {
     98|     expect(event.type).toBe("stream_event");
     99|     expect(event.delta).toBeDefined();
       |                         ^
    100|   });
    101| });
 â¯ Object.<anonymous> tests/steps/messaging.steps.ts:97:24
 â¯ StepExecutor.execute ../../node_modules/.pnpm/@deepracticex+vitest-cucumber@1.4.0_vitest@3.2.4/node_modules/@deepracticex/vitest-cucumber/src/core/runtime/StepExecutor.ts:31:25
 â¯ dist/features/agent-messaging.feature:112:20

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/10]â¯

 FAIL  dist/features/error-handling.feature > Error Handling > Catch abort errors
AssertionError: expected Error: Claude Code process exited with coâ€¦ to be undefined

[32m- Expected:[39m 
undefined

[31m+ Received:[39m 
Error {
  "message": "Claude Code process exited with code 1",
}

 â¯ Object.<anonymous> tests/steps/error-handling.steps.ts:279:19
    277|   } catch (error: any) {
    278|     // Should not throw
    279|     expect(error).toBeUndefined();
       |                   ^
    280|   }
    281| });
 â¯ StepExecutor.execute ../../node_modules/.pnpm/@deepracticex+vitest-cucumber@1.4.0_vitest@3.2.4/node_modules/@deepracticex/vitest-cucumber/src/core/runtime/StepExecutor.ts:31:5
 â¯ dist/features/error-handling.feature:96:5

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/10]â¯

 FAIL  dist/features/error-handling.feature > Error Handling > Handle network failures
AssertionError: expected 'Claude Code process exited with code 1' to match /network|simulated/i

[32m- Expected:[39m 
/network|simulated/i

[31m+ Received:[39m 
"Claude Code process exited with code 1"

 â¯ Object.<anonymous> tests/steps/error-handling.steps.ts:297:35
    295|   // Error can be in context.error OR in resultEvents
    296|   if (context.error) {
    297|     expect(context.error.message).toMatch(/network|simulated/i);
       |                                   ^
    298|   } else if (context.resultEvents && context.resultEvents.length > 0) {
    299|     const resultEvent = context.resultEvents[0];
 â¯ StepExecutor.execute ../../node_modules/.pnpm/@deepracticex+vitest-cucumber@1.4.0_vitest@3.2.4/node_modules/@deepracticex/vitest-cucumber/src/core/runtime/StepExecutor.ts:31:25
 â¯ dist/features/error-handling.feature:135:20

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/10]â¯

 FAIL  dist/features/error-handling.feature > Error Handling > Handle API errors
AssertionError: expected 'success' to match /^error/

[32m- Expected:[39m 
/^error/

[31m+ Received:[39m 
"success"

 â¯ Object.<anonymous> tests/steps/error-handling.steps.ts:323:31
    321| 
    322|   const resultEvent = context.resultEvents![0];
    323|   expect(resultEvent.subtype).toMatch(/^error/);
       |                               ^
    324| });
    325| 
 â¯ StepExecutor.execute ../../node_modules/.pnpm/@deepracticex+vitest-cucumber@1.4.0_vitest@3.2.4/node_modules/@deepracticex/vitest-cucumber/src/core/runtime/StepExecutor.ts:31:25
 â¯ dist/features/error-handling.feature:169:20

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/10]â¯

 FAIL  dist/features/error-handling.feature > Error Handling > Handle max turns error
AssertionError: expected 'success' to be 'error_max_turns' // Object.is equality

Expected: [32m"[7merror_max_turn[27ms"[39m
Received: [31m"[7msucces[27ms"[39m

 â¯ Object.<anonymous> tests/steps/error-handling.steps.ts:340:31
    338| 
    339|   const resultEvent = context.resultEvents![0];
    340|   expect(resultEvent.subtype).toBe(subtype);
       |                               ^
    341| });
    342| 
 â¯ StepExecutor.execute ../../node_modules/.pnpm/@deepracticex+vitest-cucumber@1.4.0_vitest@3.2.4/node_modules/@deepracticex/vitest-cucumber/src/core/runtime/StepExecutor.ts:31:25
 â¯ dist/features/error-handling.feature:203:20

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[7/10]â¯

 FAIL  dist/features/error-handling.feature > Error Handling > Handle execution errors
AssertionError: expected 'success' to be 'error_during_execution' // Object.is equality

Expected: [32m"error_during_execution"[39m
Received: [31m"success"[39m

 â¯ Object.<anonymous> tests/steps/error-handling.steps.ts:340:31
    338| 
    339|   const resultEvent = context.resultEvents![0];
    340|   expect(resultEvent.subtype).toBe(subtype);
       |                               ^
    341| });
    342| 
 â¯ StepExecutor.execute ../../node_modules/.pnpm/@deepracticex+vitest-cucumber@1.4.0_vitest@3.2.4/node_modules/@deepracticex/vitest-cucumber/src/core/runtime/StepExecutor.ts:31:25
 â¯ dist/features/error-handling.feature:237:20

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[8/10]â¯

â¯â¯â¯â¯â¯â¯ Unhandled Errors â¯â¯â¯â¯â¯â¯

Vitest caught 1 unhandled error during the test run.
This might cause false positive tests. Resolve unhandled errors to make sure your tests are not affected.

â¯â¯â¯â¯ Unhandled Rejection â¯â¯â¯â¯â¯
Error: Claude Code process aborted by user
 â¯ ChildProcess.<anonymous> ../../node_modules/.pnpm/@anthropic-ai+claude-agent-sdk@0.1.30_zod@4.1.12/node_modules/@anthropic-ai/claude-agent-sdk/sdk.mjs:6538:28
 â¯ ChildProcess.emit node:events:518:28
 â¯ abortChildProcess node:child_process:716:13
 â¯ AbortSignal.onAbortListener node:child_process:786:7
 â¯ AbortSignal.[nodejs.internal.kHybridDispatch] node:internal/event_target:827:20
 â¯ AbortSignal.dispatchEvent node:internal/event_target:762:26
 â¯ runAbort node:internal/abort_controller:447:10
 â¯ abortSignal node:internal/abort_controller:433:3
 â¯ AbortController.abort node:internal/abort_controller:466:5
 â¯ ClaudeProvider.abort src/providers/ClaudeProvider.ts:87:26
     85| 
     86|   abort(): void {
     87|     this.abortController.abort();
       |                          ^
     88|     this.abortController = new AbortController();
     89|   }

This error originated in "dist/features/error-handling.feature" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.
The latest test that might've caused the error is "Catch abort errors". It might mean one of the following:
- The error was thrown, while Vitest was running this test.
- If the error occurred after the test had been completed, this was the last documented test before it was thrown.
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯


 Test Files  4 failed | 1 passed (5)
      Tests  10 failed | 32 passed (42)
     Errors  1 error
   Start at  16:06:54
   Duration  87.63s (transform 240ms, setup 97ms, collect 318ms, tests 285.08s, environment 1ms, prepare 724ms)

â€‰ELIFECYCLEâ€‰ Test failed. See above for more details.
